<!DOCTYPE html>
<html>

<head>
  <meta charset="iso8859-1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/css/bootstrap.css" rel="stylesheet">
  <link href="/static/css/jquery-ui.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
</head>

<body>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header header">
        <button aria-controls="navbar" aria-expanded="false" class="navbar-toggle collapsed" data-target="#97bf8afda672ef73a836d55f018b43c868a97bb5"
          data-toggle="collapse" type="button">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand">Raspa Preço</span>
      </div>
      <div class="navbar-collapse collapse" id="97bf8afda672ef73a836d55f018b43c868a97bb5">
        <ul class="nav navbar-nav">
          <li>
            <a href="/" title="Site">Brasilico's Site</a>
          </li>
          <li class="active">
            <a href="/raspapreco/" title="Home">Home</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="alert alert-danger alert-dismissible collapse" role="alert" id="jsonerror">
      <button type="button" class="close" onclick="$('#jsonerror').hide()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <span>
        <p>Erro na conexão ao Servidor!
          <span id="erro"></span>
        </p>
      </span>
    </div>
    <div class="alert alert-success alert-dismissible collapse" role="alert" id="jsonsuccess">
      <button type="button" class="close" onclick="$('#jsonsuccess').hide()" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <span>
        <p>Sucesso!
          <span id="success"></span>
        </p>
      </span>
    </div>
    <ul id="rowTab" class="nav nav-tabs">
      <li class="active">
        <a data-toggle="tab" href="#sites">Site</a>
      </li>
      <li>
        <a data-toggle="tab" href="#produtos">Produto</a>
      </li>
    </ul>
    <div class="tab-content">
      <div id="sites" class="tab-pane fade in active">
        <div id="sitedetalhe" class="row">
          <div class="col-xs-8">
            <form id="frmsite" action="/api/sites" method="post" enctype="text/plain">
              <input type="hidden" id="id">
              <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" class="form-control" id="title">
              </div>
              <div class="form-group">
                <label for="url">URL:</label>
                <input type="text" class="form-control" id="url">
              </div>
              <div class="col-xs-4">
                <button class="btn btn-block btn-primary btn-default" id="btngravarsite">
                  <i class="fa fa-save"></i>&nbsp;Gravar
                </button>
              </div>
              <div class="col-xs-4">
                <button class="btn btn-block btn-info" id="btngravarsite">
                  <i class="fa fa-plus"></i>&nbsp;Novo
                </button>
              </div>
              <div class="col-xs-4">
                <button class="btn btn-block btn-danger" id="btnexlcuirsite">
                  <i class="fa fa-thumbs-up"></i>&nbsp;Excluir
                </button>
              </div>
            </form>
          </div>
          <div class="col-xs-4" id="sitelist">
            <h3>Sites cadastrados:</h3>
            <div class="form-group">
              <label for="url">Filtrar</label>
              <input type="text" class="form-control" id="txtfilter">
              <button class="btn" id="btnfilter">
                <i class="fa fa-filter"></i>OK
              </button>
            </div>
            <table class="table table-striped table-bordered table-hover table-responsive" cellspacing="0" cellpadding="0" id="sites_table">
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="produtos" class="tab-pane fade">
        <div id="produtodetail" class="row">
        </div>
      </div>
      <div id="bottom" class="row">
        <div class="col-md-12">
          Copyleft IvanBrasilico 2017 - All stuff GPLv3 Licensed except explicited or from outer sources
        </div>
      </div>
    </div>
  </div>
  <!-- /#bottom -->
  <script src="/static/js/jquery.js"></script>
  <script src="/static/js/bootstrap.js"></script>
  <script src="/static/js/jquery-ui.js"></script>
  <script type="text/javascript">
    $("#frmsite").submit(function (event) {
      // Stop form from submitting normally
      event.preventDefault();

      $('#jsonsuccess').hide();
      $('#jsonerror').hide();

      // Get some values from elements on the page:
      var $form = $(this)
      var formdata = {};
      for (var i = 0, ii = $form.length; i < ii; ++i) {
        var input = $form[i];
        if (input.name) {
          formdata[input.name] = input.value;
        }
      }
      type = 'post';
      mensagem = 'criado';
      var url = $form.attr("action");
      console.log("VAL: " + $("#id").val())
      formdata = { 'title': $("#title").val(), 'url': $("#url").val() }
      if ($("#id").val()) {
        type = 'put';
        mensagem = 'atualizado';
        url = url + '/' + $("#id").val();
        formdata = { 'id': $("#id").val(), 'title': $("#title").val(), 'url': $("#url").val() }
        $("#id").val("");
      }
      console.log(formdata)
      $.ajax({
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/vnd.api+json'
        },
        url: url,
        data: JSON.stringify(formdata),
        type: type,
        enctype: $form.attr("enctype"),
        dataType: 'json',
        success: function (data) {
          console.log(data);
          console.log("ID: " + data["id"]);
          $('#id').val(data["id"])
          $('#success').empty().append("Site " + mensagem + ".")
          $('#jsonsuccess').show();
          list_filtered(null, $('#txtfilter').val());
        },
        error: function (data) {
          console.log($form.attr("action"));
          console.log(data.responseJSON);
          $('#erro').empty().append(data.responseJSON["message"])
          $('#jsonerror').show();
        }
      });
    });
    $(document).on('click', '#sites_table tbody tr', function () {
      console.log($(this).find('td').eq(0).text());
      id = $(this).find('td').eq(0).text();
      $.getJSON('/api/sites/' + id, null, function (data) {
        console.log(data);
        console.log(data.title);
        $("#id").val(data["id"]);
        $('#title').val(data.title);
        $('#url').val(data['url']);
      });
    });
    $(document).ready(function () {
      list_filtered();
    });
    $(document).on('click', '#btnfilter', function () {
      list_filtered(null, $('#txtfilter').val());
    });
    $(document).on('click', '#btnclear', function () {
            clear_form();
    });
    $(document).on('click', '#btndelete', function () {
            form = $('#frmsites');
            url = '/api/sites';
            one_id = $('#id').val();
            delete_form_id(form, url, one_id);
    });

    var list_filtered = function (e, filter) {
      console.log(filter);
      params = null;
      url = '/api/sites';
      if (filter) {
        params = '{"filters": [{ "name": "title", "op": "like", "val": "%' + filter + '%"}]}'
        url = url + '?q=' + params
      }
      headers = { 'Content-Type': 'application/json' }
      $.getJSON(url, function (data) {
        console.log(data);
        console.log(url);
        console.log(params);
        $('#sites_table tbody tr').remove();
        $.each(data.objects, function (i, item) {
          $('<tr>').append(
            $('<td>').text(item.id),
            $('<td>').text(item.title)
          ).appendTo('#sites_table');
        });
      });
      return false;
    };
    var clear_form = function () {
          $("#id").val('');
          $('#title').val('');
          $('#url').val('');
    };
    var delete_form_id = function (form, url, one_id) {
      $.ajax({
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/vnd.api+json'
        },
        url: url + one_id,
        type: type,
        enctype: form.attr("enctype"),
        dataType: 'json',
        success: function (data) {
          console.log(data);
          clear_form();
          $('#success').empty().append("Site excluído.")
          $('#jsonsuccess').show();
          list_filtered(null, $('#txtfilter').val());
        },
        error: function (data) {
          console.log(data.responseJSON);
          $('#erro').empty().append(data.responseJSON["message"])
          $('#jsonerror').show();
        }
      });
    }
    

  </script>
</body>

</html>